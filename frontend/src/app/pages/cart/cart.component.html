<div class="container py-4">
  <h2 class="mb-3">Your Cart</h2>

  <ng-container *ngIf="cart$ | async as cart">
    <div class="alert alert-info" *ngIf="!cart.items || cart.items.length === 0">
      Your cart is empty.
    </div>

    <div class="table-responsive" *ngIf="cart.items && cart.items.length > 0">
      <table class="table table-striped align-middle">
        <thead>
          <tr>
            <th>Product</th>
            <th>Price</th>
            <th style="width: 120px">Quantity</th>
            <th>Total</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of cart.items">
            <td>{{ item.product.name }}</td>
            <td>{{ item.product.price | currency : "USD" }}</td>
            <td>
              <input
                class="form-control form-control-sm"
                type="number"
                min="1"
                [value]="item.quantity"
                (change)="updateQty(item.product._id, $event)"
              />
              <small class="text-danger" *ngIf="(item.product.stock || 0) <= 0">Out of stock</small>
            </td>
            <td>{{ item.product.price * item.quantity | currency : "USD" }}</td>
            <td>
              <button class="btn btn-outline-danger btn-sm" (click)="remove(item.product._id)">
                Remove
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="text-end mb-3" *ngIf="cart.items && cart.items.length > 0">
      <h5>
        Total:
        <span class="text-primary">{{ total$ | async | currency : "USD" }}</span>
      </h5>
    </div>

    <div class="card shadow-sm" *ngIf="cart.items && cart.items.length > 0">
      <div class="card-header">Payment & Billing</div>
      <form class="card-body" (ngSubmit)="placeOrder()" #checkoutForm="ngForm" novalidate>
        <div class="mb-3">
          <label class="form-label d-block">Payment Method</label>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="paymentMethod" [(ngModel)]="paymentMethod" value="card" />
            <label class="form-check-label">Card</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="paymentMethod" [(ngModel)]="paymentMethod" value="upi" />
            <label class="form-check-label">UPI</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="paymentMethod" [(ngModel)]="paymentMethod" value="netbanking" />
            <label class="form-check-label">Net Banking</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="paymentMethod" [(ngModel)]="paymentMethod" value="cod" />
            <label class="form-check-label">Cash on Delivery</label>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Full Name</label>
            <input class="form-control" name="fullName" [(ngModel)]="billing.fullName" required />
            <small class="text-danger" *ngIf="submitted && !billing.fullName.trim()">Full name is required.</small>
          </div>
          <div class="col-md-6">
            <label class="form-label">Email</label>
            <input class="form-control" type="email" name="email" [(ngModel)]="billing.email" required />
            <small class="text-danger" *ngIf="submitted && !isEmailValid()">Enter a valid email.</small>
          </div>
          <div class="col-md-6">
            <label class="form-label">Phone</label>
            <input class="form-control" name="phone" [(ngModel)]="billing.phone" required />
            <small class="text-danger" *ngIf="submitted && !isPhoneValid()">Enter a valid phone number.</small>
          </div>
          <div class="col-md-6">
            <label class="form-label">Address</label>
            <input class="form-control" name="address" [(ngModel)]="billing.address" required />
            <small class="text-danger" *ngIf="submitted && !billing.address.trim()">Address is required.</small>
          </div>
        </div>

        <div class="d-flex flex-wrap gap-2 mt-4">
          <button class="btn btn-primary" type="submit" [disabled]="placingOrder || hasOutOfStockItems()">
            {{ placingOrder ? "Placing Order..." : "Place Order" }}
          </button>
          <button class="btn btn-outline-success" type="button" *ngIf="latestOrder" (click)="downloadBill()">
            Download Bill
          </button>
        </div>

        <div class="alert alert-success mt-3 mb-0" *ngIf="successMessage">{{ successMessage }}</div>
        <div class="alert alert-warning mt-3 mb-0" *ngIf="hasOutOfStockItems()">
          Some cart items are out of stock. Remove them before checkout.
        </div>
        <div class="alert alert-danger mt-3 mb-0" *ngIf="errorMessage">{{ errorMessage }}</div>
      </form>
    </div>
  </ng-container>
</div>
